### 交易的本质
- 交易是由外部拥有的账户发起的签名消息，由以太坊网络传输，并被序列化后记录在以太坊区块链上。
- 交易是唯一可以触发状态更改或导致合约在EVM中执行的事物，
- 以太坊是一个全局单例状态机，交易是唯一可以改变其状态的东西。
- 合约不是自己运行的，以太坊也不会“在后台”运行。以太坊上的一切变化都始于交易。

### 交易的结构
- 交易由以下字段组成：
  - nonce：发送者的交易计数器，用于防止重放攻击。
  - gasPrice：为执行交易而愿意支付的最大gas价格。
  - gasLimit：为执行交易而愿意支付的最大gas量。
  - to：交易接收者的地址，如果是合约创建交易，则为空。
  - value：要发送到接收者的以太币数量。
  - data：要发送到接收者的数据，如果是合约创建交易，则为合约代码。
  - v, r, s：交易签名，用于验证交易的真实性。
### 交易中的nonce
- 黄皮书定义:一个标量值，等于从这个地址发送的交易数，或者对于关联code的帐户来说，是这个帐户创建合约的数量
- nonce不会明确存储为区块链中帐户状态的一部分。相反，它是通过计算发送地址的已确认交易的数量来动态计算的。
- nonce值还用于防止错误计算账声余额。nonce强制来自任何地址的交易按顺序处理，没有间隔，无论节点接收它们的顺序如何。
- 使用nonce确保所有节点计算相同的余额和正确的序列交易，等同于用于防止比特币“双重支付”(“重放攻击”)的机制。但是，由于以太坊跟踪账户余额并且不单独跟踪UTXO，因此只有在错误地计算账户余额时才会发生“双重支付”。nonce机制可以防止这种情况发生。


### 并发和nonce
- 以太坊是一个允许操作(节点，客户端，DApps)并发的系统，但强制执行单例状态。例如，出块的时候只有一个系统状态。

- 假如我们有多个独立的钱包应用或客户端，比如MetaMask和Geth,它们可以使用相同的地址生成交易。如果我们希望它们都够同时发送交易，该怎么设置交易的nonce呢?
- 用一台服务器为各个应用分配nonce，先来先服务--可能出现单点故障，并且失败的交易会将后续交易阻塞，
- 生成交易后不分配nonce，也不签名，而是把它放入一个队列等待另起一个节点跟踪nonce并签名交易。同样会有单点故障的可能，而且跟踪nonce和签名的节点是无法实现真正并发的。

### 交易的 value 和 data
- 交易的主要“有效负载”包含在两个字段中:value和data。交易可以同时有 value 和 data，仅有 value，仅有 data，或者既没有 value 也没有 data。所有四种组合都有效。
- 仅有 value 的交易就是一笔以太的付款
- 仅有 data 的交易一般是合约调用
- 进行合约调用的同时，我们除了传输 data，还可以发送以太，从而交易中同时包含 data 和 value
- 没有 value也没有data的交易，只是在浪费gas，但它是有效的

### 向 EOA 或合约传递 data
- 当交易包含数据有效负载时，它很可能是发送到合约地址的，但它同样可以发送给 EOA
- 如果发送 data 给 EOA，数据负载(data payload)的解释取决于钱包如果发送数据负载给合约地址，EVM 会解释为函数调用，从payload里解码出函数名称和参数，调用该函数并传入参数
- 发送给合约的数据有效负载是32字节的十六进制序列化编码:--函数选择器:函数原型的Keccak256哈希的前4个字节。这允许EVM 明确地识别将要调用的函数。
- 函数参数:根据EVM 定义的各种基本类型的规则进行编码


### 特殊交易:创建(部署)合约
- 有一中特殊的交易，具有数据负载且没有value，那就是一个创建新合约的交易。
- 合约创建交易被发送到特殊目的地地址，即零地址0x0。该地址既不代表 EOA也不代表合约。它永远不会花费以太或发起交易，它仅用作目的地，具有特殊含义“创建合约”
- 虽然零地址仅用于合同注册，但它有时会收到来自各种地址的付款。这种情况要么是偶然误操作，导致失去以太:要么是故意销毁以太
- 合约注册交易不应包含以太值，只包含合约的已编译字节码的数据有效负载。此交易的唯一效果是注册合约。